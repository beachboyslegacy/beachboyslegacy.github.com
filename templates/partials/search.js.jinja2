function fetchResultsForSearch(search, resultsTarget) {
    var terms = search.split(" ")
        .map(word => word.toLowerCase())
        .map(term => term.substring(0, 3));

    var results = [];
    for (term of terms) {
        var request = new XMLHttpRequest();

        request.addEventListener("load", function() {
            results.push(this.responseText.split("\n"));
        });

        request.open("GET", "{{base_url}}/search/" + term + ".txt");
        request.send();
    }

    setTimeout(() => {
        // Remove old results.
        // while (resultsTarget.firstChild) {
        //     resultsTarget.removeChild(parent.firstChild);
        // }

        // Add new results.
        for (result of results.flat()) {
            var resultObject = document.createElement("option");
            resultObject.value = result;

            resultsTarget.appendChild(resultObject);
        }
    }, 1000);
}

window.addEventListener("load", () => {
    var searchBar = document.getElementById("searchBar");
    var resultsTarget = document.getElementById("results");

    searchBar.addEventListener("change", () => {
        var selectedResults = [
            ...resultsTarget.options
        ].map(
            result => result.value
        ).filter(
            result => result === searchBar.value
        );

        if (selectedResults.length) {
            window.location = "{{base_url}}/item/" + selectedResults[0] + ".html";
        } else if (searchBar.value.length) {
            fetchResultsForSearch(searchBar.value, resultsTarget);
        }
    });
});
